<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SmartSnippets DA1470x SDK: HoGP Device with USB HID dongle</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SmartSnippets DA1470x SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">HoGP Device with USB HID dongle </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md298"></a>
Overview</h1>
<p>The <code>ble_usbhid_device</code> (HoGP Device) application implements a HoGP Device compliant with HoGP specification and can be used with any BLE device supporting HoGP Host (either Boot Host or Report Host), e.g. PC or a smartphone.</p>
<p>Once connected to HoGP Host, the HoGP Device application will act as a keyboard and mouse combo. </p><pre class="fragment">,-- DK ---------------.           ,-- PC/smartphone ----.
|                     |           |                     |
|  ble_usbhid_device  | &lt;= BLE =&gt; |    any HoGP Host    |
|                     |           |                     |
`---------------------'           `---------------------'
</pre><p>The <code>ble_usbhid_dongle</code> (USB HID Dongle) application implements parts of HoGP Report Host role which are necessary to work with HoGP Device implementation of <code>ble_usbhid_device</code>. Its purpose is to act as a bridge between HoGP Device and a non-BLE HID host supporting USB HID host. It is a plug &amp; play solution which works only with specific, preconfigured HoGP Device. </p><pre class="fragment">,-- DK ---------------.           ,-- DK ---------------.           ,-- PC/smartphone ----.
|                     |           |                     |           |                     |
|  ble_usbhid_device  | &lt;= BLE =&gt; |   ble_usb_dongle    | &lt;= USB =&gt; |    non-BLE device   |
|                     |           |                     |           |                     |
`---------------------'           `---------------------'           `---------------------'
</pre><h1><a class="anchor" id="autotoc_md299"></a>
Installation procedure</h1>
<p>HoGP Device project is located in the <b><code>projects/dk_apps/features/ble_usbhid/ble_usbhid_device</code></b> folder.</p>
<p>USB HID Dongle project is located in the <b><code>projects/dk_apps/features/ble_usbhid/ble_usbhid_dongle</code></b> folder.</p>
<p>To install both projects follow the <a class="el" href="install_and_debug_procedure.html">General Installation and Debugging Procedure</a>.</p>
<h1><a class="anchor" id="autotoc_md300"></a>
Profile Tuning Suite (PTS) testing</h1>
<p>The HoGP Device application can be tested with PTS as a HID Device.</p>
<p>The USB HID Dongle application can be tested with PTS as generic BLE device.</p>
<h1><a class="anchor" id="autotoc_md301"></a>
Limitations</h1>
<h2><a class="anchor" id="autotoc_md302"></a>
Connection Setup</h2>
<ol type="1">
<li>In order for the USB protocol to operate seamlessly, it is advised to connect the USB HID Dongle directly from the daughterboard to the host, and not from the JLink port of the DK's motherboard.</li>
<li>As a best practise for seamless USB testing, it is also advised to power the BLE application part of the tests through the DK's motherboard (both applications). This can be achieved by keeping the daughterboard mounted on the DK motherboard, regardless of the USB connection to the host.</li>
</ol>
<h2><a class="anchor" id="autotoc_md303"></a>
USB HID Dongle</h2>
<p>The USB HID Dongle only works with a single compatible device. The address of this device is pre-programmed in the dongle. This is due to following limitations:</p>
<ol type="1">
<li>The dongle is a non-interactive device, depriving the user the choice of a HoGP device to connect to. Having a pre-programmed device address, the connection process is as quick as possible; there is no need to scan for compatible devices prior to connection and also there is no conflict if other compatible devices exist in the neighborhood.</li>
<li>The dongle does not have a full HID parser and thus it cannot parse and understand reports received from either device or host. It acts only as a bridge passing reports from one side to another. This translates to using the same report map over the USB-connected and the BLE-connected device. This is achieved by hard-coding the report map of the dongle to match the HoGP device's report map.</li>
</ol>
<h1><a class="anchor" id="autotoc_md304"></a>
Manual testing</h1>
<h2><a class="anchor" id="autotoc_md305"></a>
HoGP Device only</h2>
<p>After startup, the device starts directed advertising to bonded host, if any, and then switches to undirected advertising. The undirected advertising is enabled for 180 seconds. To enable it again, press K1 button on the DK.</p>
<p>The advertising data contains <em>HID Service</em> UUID and <em>Generic HID</em> appearance. The scan response contains <em>Dialog HoGP Device</em> name.</p>
<p>To remove the bonding information from the device, reset the device while holding K1 button pressed.</p>
<p>Once connected, the device acts as a keyboard and mouse combo with the following features:</p><ul>
<li>mouse cursor movement is simulated in a rhomb-shaped pattern</li>
<li>key press is simulated by sending press and release of the Num Lock key (LED state should change on other keyboards connected to the same host)</li>
<li>D2 LED is synchronized with the Caps Lock state of the host (LED can be toggled by pressing Caps Lock key on other keyboards connected to the same host)</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The Num Lock and Caps Lock states synchronization depends on the host. The behaviour as described above can be observed with Windows and Linux hosts, while OSX hosts do not seem to properly synchronize the key states.</dd></dl>
<p>Testing procedure:</p><ol type="1">
<li>Flash the <code>ble_usbhid_device</code> application as described above.</li>
<li>Reset the DK</li>
<li>The device starts advertising; use a compatible PC or smartphone to scan and connect to the device.</li>
<li>Due to security requirements (encryption required) the device sends <em>Security Request</em> after connection is established with the host, to initiate pairing and enable encryption.</li>
<li>The device actions should be visible on the host after pairing:<ul>
<li>check that the mouse cursor is moving as expected</li>
<li>check that Num Lock LED toggles every 1 second on host</li>
<li>check that Caps Lock key toggles D2 LED on DK</li>
</ul>
</li>
<li>Disconnect the device (e.g. reset the DK)</li>
<li>The host should reconnect with the device and encryption should be enabled immediately without needing to pair both devices again.</li>
</ol>
<h2><a class="anchor" id="autotoc_md306"></a>
USB HID Dongle with HoGP Device</h2>
<p>The procedure to setup HoGP Device is the same as in <b>HoGP Device only</b> scenario.</p>
<p>The USB HID Dongle device does not require any user interaction. Once run, it constantly scans for the predefined device and automatically connects, once the matching device is found. If the connected device is compatible with the dongle, the security and configuration is handled automatically, and the device transfers all HID traffic from/to the HoGP Device to/from the connected USB HID host.</p>
<p>The address of the HoGP device that will connect to the dongle is written in the dongle's <code>NVMS_PARAM</code> partition (see usage <a class="el" href="nvparam_script.html">here</a>) at an offset address of <code>0x40</code>, in the following format: </p><pre class="fragment"> len | name
-----+----------------------- 
   1 | address type
     |     0x00 = public
     |     0x01 = random
   6 | device address
</pre><p>Alternatively, assuming the <code>NVMS_PARAM</code> partition starts at <code>0x00700000</code>, the above address can be written using <code>cli_programmer</code>, e.g. the following command will setup the dongle to work with the device using a public address <code>80:EA:CA:AA:AA:AA</code>: </p><pre class="fragment">./binaries/cli_programmer gdbserver write_oqspi_bytes 0x00700040 0x00 0xAA 0xAA 0xAA 0xca 0xea 0x80
</pre><p>If no address is found on the flash (or the address type is invalid), the default BD address is used.</p>
<p>Testing procedure:</p><ol type="1">
<li>Flash the applications <code>ble_usbhid_device</code> and <code>ble_usbhid_dongle</code> as described above. <dl class="section warning"><dt>Warning</dt><dd>Make sure both applications are built with the same SDK core code.</dd></dl>
</li>
<li>Setup the HoGP device's DK address on the dongle DK as described above (optional).</li>
<li>Connect the dongle DK Daughterboard via USB to a compatible host. It should be enumerated as HID device.</li>
<li>Reset the HoGP device DK</li>
<li>When D2 LED is on, this indicates that the dongle DK is successfully connected to the device DK.</li>
<li>The same behaviour as in <b>HoGP Device only</b> scenario should be observed and verified on the host, which is now connected to the dongle.</li>
<li>Reset either of devices and the connection should be established again automatically. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Dec 9 2022 13:50:40 for SmartSnippets DA1470x SDK by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
