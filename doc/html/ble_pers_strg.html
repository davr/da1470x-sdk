<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SmartSnippets DA1470x SDK: BLE persistent storage (flash) for bonded devices</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SmartSnippets DA1470x SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">BLE persistent storage (flash) for bonded devices </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md26"></a>
Overview</h1>
<p>BLE Manager is able to automatically manage list of bonded devices in both RAM and on persistent storage, i.e. QSPI flash. By default, devices are managed in RAM only and persistent storage has to be explicitly enabled in application configuration. Device data is stored using NVMS on generic partition.</p>
<p>Two kind of data are stored:</p><ul>
<li>device pairing data (exchanged keys and related information)</li>
<li>application-defined data managed using ble_storage API (only values set with <code>persistent</code> flag are stored in flash, e.g. CCC descriptor values)</li>
</ul>
<h1><a class="anchor" id="autotoc_md27"></a>
Configuration</h1>
<p>Persistent storage can be enabled in application by following entries in application configuration file:</p>
<div class="fragment"><div class="line"><span class="comment">// enable BLE persistent storage</span></div>
<div class="line"><span class="preprocessor">#define CONFIG_BLE_STORAGE</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// enable Flash and NVMS adapters with VES (required by BLE persistent storage)</span></div>
<div class="line"><span class="preprocessor">#define dg_configFLASH_ADAPTER                  1</span></div>
<div class="line"><span class="preprocessor">#define dg_configNVMS_ADAPTER                   1</span></div>
<div class="line"><span class="preprocessor">#define dg_configNVMS_VES                       1</span></div>
</div><!-- fragment --><p>By default, data are stored on partition at following offsets:</p><ul>
<li>device pairing data at offset 0x0000 (maximum length depends on max number of bonded devices)</li>
<li>application data at offset 0x0500 (maximum length of 1024 bytes)</li>
</ul>
<p>This can be changed using following entries in application configuration file:</p>
<div class="fragment"><div class="line"><span class="comment">// set pairing data storage at offset 0x1000 on generic partition</span></div>
<div class="line"><span class="preprocessor">#define CONFIG_BLE_STORAGE_KEY_PART_OFFSET (0x1000)</span></div>
<div class="line"><span class="comment">// set application data storage at offset 0x1000 on generic partition</span></div>
<div class="line"><span class="preprocessor">#define CONFIG_BLE_STORAGE_APV_PART_OFFSET (0x1500)</span></div>
<div class="line"><span class="comment">// set maximum length of application data storage to 512</span></div>
<div class="line"><span class="preprocessor">#define CONFIG_BLE_STORAGE_APV_PART_LENGTH (512)</span></div>
</div><!-- fragment --><p>In case application tries to write more application data than allowed, data that do not fit will be discarded.</p>
<p>A compile-time assert is enabled to ensure gap between device data offset and application data offset is large enough to fit maximum number of bonded devices, as configured.</p>
<p>Number of maximum bonded devices can be set in <a class="el" href="ble__config_8h.html" title="BLE configuration options.">ble_config.h</a> file:</p>
<div class="fragment"><div class="line"><span class="comment">// by default 8 devices can be bonded at the same time</span></div>
<div class="line"><span class="preprocessor">#define defaultBLE_MAX_BONDED (8)</span></div>
</div><!-- fragment --><p>When trying to bond more devices than allowed an error will be returned to application and it should be handled there depending on requirements, i.e. application can either unbond one of devices or perform pairing without bonding.</p>
<h1><a class="anchor" id="autotoc_md28"></a>
Storage format (device data)</h1>
<h2><a class="anchor" id="autotoc_md29"></a>
Header</h2>
<p>Device storage starts with magic value which identifies data region - if this values does not match with value included in software, data will not be loaded during startup as it is assumed they are not valid (i.e. were never written). Magic value is as follows:</p>
<div class="fragment"><div class="line">42 4C 45 5F 4B 45 59 01</div>
</div><!-- fragment --><p>In ASCII code this translates to <code>BLE_KEY\x01</code>. Last byte (0x01) is used for storage format versioning and should be changed whenever storage layout changes. This ensures that data written in old storage layout will not be loaded into new structure. Any change to this byte will cause existing data to be considered invalid and won't be loaded from flash. This can be used in case storage format is changed for some reason.</p>
<p>Magic value is followed immediately by single byte value which contains number of entries for device data. When loading data from storage this value will be compared against current value of <code>defaultBLE_MAX_BONDED</code> and lesser of both will determine maximum number of device entries to be read from flash. On first write, this will be updated with <code>defaultBLE_MAX_BONDED</code>. This is to ensure backwards-compatibility in case <code>defaultBLE_MAX_BONDED</code> is changed between software versions without need to change magic value.</p>
<h2><a class="anchor" id="autotoc_md30"></a>
Device data</h2>
<p>Header is followed by actual bonding information for each device. Number of entries is always the same as stored in header (see above). Each entry has format as defined below. Note that there are unused bytes in structure below which are used for padding and have undefined value.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">offset  </th><th class="markdownTableHeadNone">len  </th><th class="markdownTableHeadNone">contents   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0000  </td><td class="markdownTableBodyNone">4  </td><td class="markdownTableBodyNone">flags   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0004  </td><td class="markdownTableBodyNone">7  </td><td class="markdownTableBodyNone">device address   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0010  </td><td class="markdownTableBodyNone">27  </td><td class="markdownTableBodyNone">LTK   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0030  </td><td class="markdownTableBodyNone">27  </td><td class="markdownTableBodyNone">remote LTK   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0050  </td><td class="markdownTableBodyNone">16  </td><td class="markdownTableBodyNone">IRK   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0060  </td><td class="markdownTableBodyNone">18  </td><td class="markdownTableBodyNone">CSRK   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0074  </td><td class="markdownTableBodyNone">18  </td><td class="markdownTableBodyNone">remote CSRK   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md31"></a>
Flags</h4>
<p>Flags value is a bitmask which determines other device properties, in particular it defines which fields in device entry have valid value. </p><pre class="fragment">0x0001 = device entry is not used (i.e. any other data for this entry is ignored)
0x0002 = device entry has valid LTK
0x0004 = device entry has valid remote LTK
0x0008 = device entry has valid IRK
0x0010 = device entry has valid CSRK
0x0020 = device entry has valid remote CSRK
0x0040 = valid keys for this device entry are authenticated (MITM bonding was used)
</pre><h4><a class="anchor" id="autotoc_md32"></a>
Device address</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">offset  </th><th class="markdownTableHeadNone">len  </th><th class="markdownTableHeadNone">contents   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0000  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">address type (0x00 = public, 0x01 = random)   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0001  </td><td class="markdownTableBodyNone">6  </td><td class="markdownTableBodyNone">device address   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md33"></a>
LTK and remote LTK</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">offset  </th><th class="markdownTableHeadNone">len  </th><th class="markdownTableHeadNone">contents   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0000  </td><td class="markdownTableBodyNone">8  </td><td class="markdownTableBodyNone">Rand   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0008  </td><td class="markdownTableBodyNone">2  </td><td class="markdownTableBodyNone">EDIV   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x000A  </td><td class="markdownTableBodyNone">16  </td><td class="markdownTableBodyNone">LTK   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x001A  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">key size   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md34"></a>
IRK</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">offset  </th><th class="markdownTableHeadNone">len  </th><th class="markdownTableHeadNone">contents   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0000  </td><td class="markdownTableBodyNone">16  </td><td class="markdownTableBodyNone">IRK   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md35"></a>
CSRK and remote CSRK</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">offset  </th><th class="markdownTableHeadNone">len  </th><th class="markdownTableHeadNone">contents   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0000  </td><td class="markdownTableBodyNone">16  </td><td class="markdownTableBodyNone">CSRK   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0010  </td><td class="markdownTableBodyNone">2  </td><td class="markdownTableBodyNone">sign counter   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md36"></a>
Storage format (application data)</h1>
<h2><a class="anchor" id="autotoc_md37"></a>
Header</h2>
<p>Application storage starts with magic value which identifies data region - if this values does not match with value included in software, data will not be loaded during startup as it is assumed they are not valid (i.e. were never written). Magic value is as follows:</p>
<div class="fragment"><div class="line">42 4C 45 5F 41 50 56 01</div>
</div><!-- fragment --><p>In ASCII code this translates to <code>BLE_APV\x01</code>. The last byte (0x01) is used for storage format versioning and should be changed whenever the storage layout changes. This ensures that data written in old storage layout will not be loaded into new structure.</p>
<h2><a class="anchor" id="autotoc_md38"></a>
Application data</h2>
<p>Header is followed by the actual application data for each device. Data is a sequence of triplets in form of &lt;type, key, value&gt;. Data for each device starts with <code>type=0x01</code> element and follows until next <code>type=0x01</code> or <code>type=0x00</code> element is found.</p>
<h4><a class="anchor" id="autotoc_md39"></a>
Type</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">type  </th><th class="markdownTableHeadNone">len  </th><th class="markdownTableHeadNone">contents   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x00  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">empty element, used to indicate end of data   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x01  </td><td class="markdownTableBodyNone">7  </td><td class="markdownTableBodyNone">device address   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x02  </td><td class="markdownTableBodyNone">4  </td><td class="markdownTableBodyNone">integer value   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x03  </td><td class="markdownTableBodyNone">var  </td><td class="markdownTableBodyNone">variable length data   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md40"></a>
Key</h4>
<p>Key is 4-byte integer value corresponding to key used in ble_storage API calls.</p>
<h4><a class="anchor" id="autotoc_md41"></a>
Device address</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">offset  </th><th class="markdownTableHeadNone">len  </th><th class="markdownTableHeadNone">contents   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0000  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">address type (0x00 = public, 0x01 = random)   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0001  </td><td class="markdownTableBodyNone">6  </td><td class="markdownTableBodyNone">device address   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md42"></a>
Variable length data</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">offset  </th><th class="markdownTableHeadNone">len  </th><th class="markdownTableHeadNone">contents   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0000  </td><td class="markdownTableBodyNone">2  </td><td class="markdownTableBodyNone">length of following data   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0002  </td><td class="markdownTableBodyNone">var  </td><td class="markdownTableBodyNone">application data value, number of bytes is <code>len</code>   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Dec 9 2022 13:50:40 for SmartSnippets DA1470x SDK by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
